# name: Generate Articles

# on:
#   workflow_dispatch:
#   push:
#     branches: ["main"]
#     paths:
#       - ".github/workflows/**"
#   schedule:
#     # Every 2 hours UTC
#     - cron: "0 */1 * * *"
  
# permissions:
#   contents: write
#   actions: read

# jobs:
#   # ðŸ•’ Test job to confirm cron fires
#   test-schedule:
#     runs-on: ubuntu-latest
#     steps:
#       - name: Print trigger time
#         run: echo "Schedule triggered at $(date -u)"

#   generate-articles:
#     runs-on: ubuntu-latest
#     timeout-minutes: 60
#     needs: test-schedule

#     env:
#       GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
#       GEMINI_API_KEY_1: ${{ secrets.GEMINI_API_KEY_1 }}
#       GEMINI_API_KEY_2: ${{ secrets.GEMINI_API_KEY_2 }}
#       GEMINI_API_KEY_3: ${{ secrets.GEMINI_API_KEY_3 }}
#       GEMINI_API_KEY_4: ${{ secrets.GEMINI_API_KEY_4 }}
#       GEMINI_API_KEY_5: ${{ secrets.GEMINI_API_KEY_5 }}
#       GEMINI_API_KEY_6: ${{ secrets.GEMINI_API_KEY_6 }}
#       CLOUDINARY_URL: ${{ secrets.CLOUDINARY_URL }}
#       CLOUDINARY_CLOUD_NAME: ${{ secrets.CLOUDINARY_CLOUD_NAME }}
#       CLOUDINARY_API_KEY: ${{ secrets.CLOUDINARY_API_KEY }}
#       CLOUDINARY_API_SECRET: ${{ secrets.CLOUDINARY_API_SECRET }}
#       EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
#       AMAZON_ACCESS_KEY: ${{ secrets.AMAZON_ACCESS_KEY }}
#       AMAZON_SECRET_KEY: ${{ secrets.AMAZON_SECRET_KEY }}
#       AMAZON_PARTNER_TAG: ${{ secrets.AMAZON_PARTNER_TAG }}

#     steps:
#       - name: â¬‡ï¸ Checkout repository
#         uses: actions/checkout@v4
#         with:
#           token: ${{ secrets.GITHUB_TOKEN }}
#           fetch-depth: 0

#       - name: ðŸ Set up Python 3.11
#         uses: actions/setup-python@v5
#         with:
#           python-version: "3.11"
#           cache: "pip"

#       - name: ðŸ“¦ Install dependencies
#         run: |
#           python -m pip install --upgrade pip
#           pip install \
#             google-genai pillow six requests markdown pyyaml numpy \
#             scikit-learn nltk coverage nose pluggy py randomize \
#             simplejson python-dotenv
#           pip install --no-deps \
#             git+https://${{ secrets.GITHUB_TOKEN }}@github.com/Telefonica/amazon-paapi5-sdk.git

#       - name: ðŸ—‚ï¸ Create required directories
#         run: |
#           mkdir -p generated-articles
#           mkdir -p data
#           mkdir -p article-prompts

#       - name: ðŸ§ª Check for required files
#         run: |
#           touch data/keywords.txt
#           touch data/processed_keywords.txt
#           touch data/keywords-generated.txt
#           touch data/links.txt

#       - name: ðŸš€ Run article generation script
#         id: generate
#         continue-on-error: true
#         run: |
#           echo "Running article generator..."
#           if [ -f ".github/scripts/generate_articles.py" ]; then
#             python .github/scripts/generate_articles.py
#           else
#             echo "::error:: generate_articles.py not found"
#             ls -la .github/scripts/ || echo "No scripts directory"
#             exit 1
#           fi

#       - name: ðŸ”Ž Check for file changes
#         id: verify-changed-files
#         run: |
#           if git diff --quiet && git diff --staged --quiet; then
#             echo "changed=false" >> $GITHUB_OUTPUT
#           else
#             echo "changed=true" >> $GITHUB_OUTPUT
#             git status
#           fi

#       - name: âœ… Commit and push changes
#         if: steps.verify-changed-files.outputs.changed == 'true'
#         run: |
#           git config --local user.name 'github-actions[bot]'
#           git config --local user.email 'github-actions[bot]@users.noreply.github.com'
#           git add generated-articles/ data/ article-prompts/ .last_keyword_index || true
#           git commit -m "Auto-generate articles and prompts $(date -u '+%Y-%m-%d %H:%M:%S UTC') [skip ci]" || exit 0
#           for i in 1 2 3; do
#             git push && break || sleep 5
#           done

#       - name: ðŸ“‹ Create workflow summary
#         if: always()
#         run: |
#           echo "## Workflow Summary" >> $GITHUB_STEP_SUMMARY
#           echo "- **Workflow**: ${{ github.workflow }}" >> $GITHUB_STEP_SUMMARY
#           echo "- **Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
#           echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
#           echo "- **Timestamp**: $(date -u)" >> $GITHUB_STEP_SUMMARY
#           echo "- **Articles Generated**: $(ls generated-articles/*.md 2>/dev/null | wc -l)" >> $GITHUB_STEP_SUMMARY
#           echo "- **Prompts Saved**: $(ls article-prompts/*.txt 2>/dev/null | wc -l)" >> $GITHUB_STEP_SUMMARY

#       - name: ðŸ•°ï¸ Keep repository active
#         if: always()
#         run: |
#           echo "Workflow completed at $(date -u)" > .github/last_run.txt
#           git add .github/last_run.txt || true
#           git commit -m "Update last run timestamp [skip ci]" || true
#           git push || true

#       - name: âŒ Notify on failure
#         if: failure()
#         run: |
#           echo "::error:: Article generation workflow failed"
#           echo "Check logs above for details"


name: Generate Articles

on:
  # Manual trigger (run once to activate cron)
  workflow_dispatch:

  # Run on push to main
  push:
    branches:
      - main

  # Run every 2 hours (UTC)
  schedule:
    - cron: "0 */2 * * *"

permissions:
  contents: write

jobs:
  generate-articles:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    env:
      # ===============================
      # Gemini API keys
      # ===============================
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      GEMINI_API_KEY_1: ${{ secrets.GEMINI_API_KEY_1 }}
      GEMINI_API_KEY_2: ${{ secrets.GEMINI_API_KEY_2 }}
      GEMINI_API_KEY_3: ${{ secrets.GEMINI_API_KEY_3 }}
      GEMINI_API_KEY_4: ${{ secrets.GEMINI_API_KEY_4 }}
      GEMINI_API_KEY_5: ${{ secrets.GEMINI_API_KEY_5 }}
      GEMINI_API_KEY_6: ${{ secrets.GEMINI_API_KEY_6 }}

      # ===============================
      # Cloudinary
      # ===============================
      CLOUDINARY_URL: ${{ secrets.CLOUDINARY_URL }}
      CLOUDINARY_CLOUD_NAME: ${{ secrets.CLOUDINARY_CLOUD_NAME }}
      CLOUDINARY_API_KEY: ${{ secrets.CLOUDINARY_API_KEY }}
      CLOUDINARY_API_SECRET: ${{ secrets.CLOUDINARY_API_SECRET }}

      # ===============================
      # Amazon PAAPI
      # ===============================
      AMAZON_ACCESS_KEY: ${{ secrets.AMAZON_ACCESS_KEY }}
      AMAZON_SECRET_KEY: ${{ secrets.AMAZON_SECRET_KEY }}
      AMAZON_PARTNER_TAG: ${{ secrets.AMAZON_PARTNER_TAG }}

    steps:
      # --------------------------------
      # Checkout repository
      # --------------------------------
      - name: â¬‡ï¸ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # --------------------------------
      # Python setup
      # --------------------------------
      - name: ðŸ Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip

      # --------------------------------
      # Install dependencies (FIXED)
      # --------------------------------
      - name: ðŸ“¦ Install Python dependencies
        run: |
          python -m pip install --upgrade pip

          # Core dependencies
          pip install \
            google-genai \
            pillow \
            requests \
            markdown \
            pyyaml \
            numpy \
            scikit-learn \
            nltk \
            simplejson \
            python-dotenv \
            six \
            urllib3

          # Amazon PAAPI SDK (WITH deps)
          pip install \
            git+https://${{ secrets.GITHUB_TOKEN }}@github.com/Telefonica/amazon-paapi5-sdk.git

      # --------------------------------
      # Prepare folders & files
      # --------------------------------
      - name: ðŸ—‚ï¸ Prepare directories and files
        run: |
          mkdir -p generated-articles
          mkdir -p data
          mkdir -p article-prompts
          mkdir -p .github

          touch data/keywords.txt
          touch data/processed_keywords.txt
          touch data/keywords-generated.txt
          touch data/links.txt

      # --------------------------------
      # Debug check (safe to keep)
      # --------------------------------
      - name: ðŸ” Verify PAAPI dependencies
        run: |
          python -c "import six; print('six OK')"
          python -c "from paapi5_python_sdk.api.default_api import DefaultApi; print('PAAPI SDK OK')"

      # --------------------------------
      # Run article generator
      # --------------------------------
      - name: ðŸš€ Run article generator
        run: |
          echo "Starting article generation..."
          python .github/scripts/generate_articles.py

      # --------------------------------
      # Detect file changes
      # --------------------------------
      - name: ðŸ”Ž Detect changes
        id: changes
        run: |
          if git diff --quiet; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            git status
          fi

      # --------------------------------
      # Commit & push generated content
      # --------------------------------
      - name: âœ… Commit and push changes
        if: steps.changes.outputs.changed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add generated-articles data article-prompts .last_keyword_index || true
          git commit -m "Auto-generate articles $(date -u '+%Y-%m-%d %H:%M:%S UTC')" || exit 0
          git push

      # --------------------------------
      # Keep repository active (cron-safe)
      # --------------------------------
      - name: ðŸ•°ï¸ Update workflow heartbeat
        run: |
          echo "Last run: $(date -u)" > .github/last_run.txt
          git add .github/last_run.txt || true
          git commit -m "Workflow heartbeat" || true
          git push || true

      # --------------------------------
      # Workflow summary
      # --------------------------------
      - name: ðŸ“‹ Workflow summary
        if: always()
        run: |
          echo "## Workflow Summary" >> $GITHUB_STEP_SUMMARY
          echo "- Trigger: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- Status: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- Time: $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "- Articles: $(ls generated-articles/*.md 2>/dev/null | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "- Prompts: $(ls article-prompts/*.txt 2>/dev/null | wc -l)" >> $GITHUB_STEP_SUMMARY
